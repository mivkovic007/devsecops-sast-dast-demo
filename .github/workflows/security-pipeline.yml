dast-zap:
  name: DAST - OWASP ZAP
  runs-on: ubuntu-latest
  strategy:
    matrix:
      include:
        - app-folder: app-vulnerable
          port: 5000
        - app-folder: app-secure
          port: 5001

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r ${{ matrix.app-folder }}/requirements.txt

    - name: Start app in background
      run: |
        python ${{ matrix.app-folder }}/app.py &
        APP_PID=$!
        sleep 20

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: "http://127.0.0.1:${{ matrix.port }}"
        artifact_name: "zap_report_${{ matrix.app-folder }}"
        fail_action: false

    - name: Stop Flask app
      run: |
        kill $APP_PID || true

    - name: Upload ZAP report
      uses: actions/upload-artifact@v4
      with:
        name: "zap_report_${{ matrix.app-folder }}"
        path: |
          report_json.json
          report_md.md
          report_html.html
