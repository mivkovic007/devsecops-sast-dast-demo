name: DevSecOps Security Pipeline

on:
  push:
    branches:
      - main

jobs:

# ===============================
# SAST
# ===============================

  sast-vulnerable:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - name: Semgrep scan - vulnerable
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/owasp-top-ten"
          include: app-vulnerable

  sast-secure:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Semgrep scan - secure
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/owasp-top-ten"
          include: app-secure


# ===============================
# SNYK
# ===============================

  snyk-vulnerable:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install minimal deps (ignore conflict)
        run: |
          pip install Flask==2.3.3

      - name: Snyk scan vulnerable
        uses: snyk/actions/python@v1
        with:
          args: --file=app-vulnerable/requirements.txt --skip-unresolved
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-secure:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - run: pip install -r app-secure/requirements.txt

      - name: Snyk scan secure
        uses: snyk/actions/python@v1
        with:
          args: --file=app-secure/requirements.txt --skip-unresolved
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}


# ===============================
# DAST
# ===============================

  dast-vulnerable:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - run: pip install Flask==2.3.3 gunicorn

      - name: Start vulnerable app
        run: |
          cd app-vulnerable
          nohup gunicorn -b 127.0.0.1:5000 app:app > server.log 2>&1 &
          sleep 5

      - uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://127.0.0.1:5000"
          fail_action: false

      - run: pkill gunicorn || true


  dast-secure:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - run: |
          pip install -r app-secure/requirements.txt
          pip install gunicorn

      - name: Start secure app
        run: |
          cd app-secure
          nohup gunicorn -b 127.0.0.1:5001 app:app > server.log 2>&1 &
          sleep 5

      - uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://127.0.0.1:5001"
          fail_action: false

      - run: pkill gunicorn || true
